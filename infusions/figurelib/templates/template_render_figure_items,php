<?php
/*-------------------------------------------------------+
| PHP-Fusion Content Management System
| Copyright (C) PHP-Fusion Inc
| http://www.php-fusion.co.uk/
+--------------------------------------------------------+
| Filename: template/template_render_figure_items.php based on template/weblinks.php
| Author: PHP-Fusion Development Team
| Modification: Catzenjaeger
| URL: www.aliencollectors.com
| E-Mail: admin@aliencollectors.com
+--------------------------------------------------------+
| This program is released as free software under the
| Affero GPL license. You can redistribute it and/or
| modify it under the terms of this license which you
| can read by viewing the included agpl.txt or online
| at www.gnu.org/licenses/agpl.html. Removal of this
| copyright header is strictly prohibited without
| written permission from the original author(s).
+--------------------------------------------------------*/
require_once "../../maincore.php";
require_once INCLUDES."infusions_include.php";
if (!defined("IN_FUSION")) { die("Access Denied"); }
include INFUSIONS."figurelib/infusion_db.php";
global $userdata;

// ******************************************************************************************			
// FIGURE
// ******************************************************************************************
if (!function_exists('render_figure_items')) {
	function render_figure_items($info) {
		global $locale;
		echo render_breadcrumbs();
	
$result = dbquery(
			"SELECT 
				f.*,
				fc.figure_cat_id, 
				fc.figure_cat_name, 		
				fu.user_id, 
				fu.user_name, 
				fu.user_status, 
				fu.user_avatar, 
				fman.figure_manufacturer_id,
				fman.figure_manufacturer_name, 
				fb.figure_brand_name, 
				fy.figure_year_id, 
				fy.figure_year, 
				fs.figure_scale_id, 
				fs.figure_scale_name, 
				fl.figure_limitation_id, 
				fl.figure_limitation_name,
				fpoa.figure_poa_id,
				fpoa.figure_poa_name,
				fpack.figure_packaging_id,
				fpack.figure_packaging_name,
				fmat.figure_material_id,
				fmat.figure_material_name				
			FROM ".DB_FIGURE_ITEMS." f
			LEFT JOIN ".DB_USERS." fu ON f.figure_submitter=fu.user_id
			INNER JOIN ".DB_FIGURE_CATS." fc ON f.figure_cat=fc.figure_cat_id
			INNER JOIN ".DB_FIGURE_MANUFACTURERS." fman ON fman.figure_manufacturer_id = f.figure_manufacturer
			INNER JOIN ".DB_FIGURE_BRANDS." fb ON fb.figure_brand_id = f.figure_brand
			INNER JOIN ".DB_FIGURE_SCALES." fs ON fs.figure_scale_id = f.figure_scale
			INNER JOIN ".DB_FIGURE_YEARS." fy ON fy.figure_year_id = f.figure_pubdate
			INNER JOIN ".DB_FIGURE_LIMITATIONS." fl ON fl.figure_limitation_id = f.figure_limitation
			INNER JOIN ".DB_FIGURE_POAS." fpoa ON fpoa.figure_poa_id = f.figure_poa
			INNER JOIN ".DB_FIGURE_PACKAGINGS." fpack ON fpack.figure_packaging_id = f.figure_packaging
			INNER JOIN ".DB_FIGURE_MATERIALS." fmat ON fmat.figure_material_id = f.figure_material
			".(multilang_table("FI") ? "WHERE figure_language='".LANGUAGE."' AND" : "WHERE")." f.figure_freigabe='1'  
			AND figure_id='".$_GET['figure_id']."'
			");
			
	if (dbrows($result) != 0) {
		while ($data = dbarray($result)) {

// IMAGES ####################################################################################	
openside("<div class='well clearfix'><strong></strong>&nbsp;&nbsp;<a href='".INFUSIONS."figurelib/figures.php?figure_id=".$data['figure_id']."'>".trimlink($data['figure_title'], 23)." (".trimlink($data['figure_manufacturer_name'], 23).") [".$data['figure_year']."]</a></div>");

$figure_id = $data['figure_id'];
	
		$image_count = dbcount("(figure_images_image_id)", DB_FIGURE_IMAGES, "figure_images_figure_id='$figure_id'");
    
    if ($image_count) {
        echo "<div class='row'>\n";
        $resultimage = dbquery("SELECT * FROM ".DB_FIGURE_IMAGES." WHERE figure_images_figure_id='$figure_id'");
                while ($image_data = dbarray($resultimage)) {

            $image_thumb = get_figure_image_path($image_data['figure_images_image'], $image_data['figure_images_thumb']);
            if (!$image_thumb) {
                $image_thumb = IMAGES."imagenotfound70.jpg";
            }
            echo "<div class='col-xs-12 col-sm-4'>\n";
            

            echo "<div class='' style='height: 250px '>";
            echo "<img class='img-responsive img-thumbnail' src='".$image_thumb."' alt='".$locale['figure_588']."' />\n";
            echo "</div>";

            echo "</div>\n";

        }

        echo "</div>\n";

    }



// ############################################################################################	


// ###########  FIGURE DETAILS   ##############################################################
	
				
/*		
   echo "<div class='panel-group' id='accordion'><div class='panel panel-default'><div class='panel-heading'>
      <h4 class='panel-title'><a data-toggle='collapse' data-parent='#accordion' href='#collapse1'>".$locale['figure_441']."</a></h4></div>
    <div id='collapse1' class='panel-collapse collapse in'><div class='panel-body'>".$data['figure_variant']."</div></div></div>\n";
   
   echo "<div class='panel panel-default'><div class='panel-heading'>
		<h4 class='panel-title'><a data-toggle='collapse' data-parent='#accordion' href='#collapse2'>".$locale['figure_439']."</a></h4></div>
    <div id='collapse2' class='panel-collapse collapse'><div class='panel-body'>".$data['figure_series']."</div></div></div>\n";
	
   echo "<div class='panel panel-default'><div class='panel-heading'>
		<h4 class='panel-title'><a data-toggle='collapse' data-parent='#accordion' href='#collapse3'>".$locale['figure_417']."</a></h4></div>
    <div id='collapse3' class='panel-collapse collapse'><div class='panel-body'>".$data['figure_manufacturer_name']."</div></div></div>\n";
	
   echo "<div class='panel panel-default'><div class='panel-heading'>
		<h4 class='panel-title'><a data-toggle='collapse' data-parent='#accordion' href='#collapse4'>".$locale['figure_419']."</a></h4></div>
    <div id='collapse4' class='panel-collapse collapse'><div class='panel-body'>".$data['figure_year']."</div></div></div>\n";
	
   echo "<div class='panel panel-default'><div class='panel-heading'>
		<h4 class='panel-title'><a data-toggle='collapse' data-parent='#accordion' href='#collapse5'>".$locale['figure_436']."</a></h4></div>
    <div id='collapse5' class='panel-collapse collapse'><div class='panel-body'>".$data['figure_country']."</div></div></div>\n";
    
   echo "<div class='panel panel-default'><div class='panel-heading'>
      <h4 class='panel-title'><a data-toggle='collapse' data-parent='#accordion' href='#collapse6'>".$locale['figure_452']."</a></h4></div>
    <div id='collapse6' class='panel-collapse collapse'><div class='panel-body'>".$data['figure_artists']."</div>
	</div></div></div>\n";

*/
		
			// Variant

			echo "<table class='table table-hover'><tr>\n";	
				echo "<colgroup><col width='20%'><col width='80%'></colgroup>\n"; 			
					echo "<td  class='navbar-default'><div class='text-smaller text-uppercase'><strong>".$locale['figure_441'].":</strong></div></td>\n";
					echo "<td  class=''><small>".$data['figure_variant']."</small></td>\n";	
			echo "</tr>\n";		
			
			// Series
			echo "<tr>\n";			
					echo "<td  class='navbar-default'><div class='text-smaller text-uppercase'><strong>".$locale['figure_439'].":</strong></div></td>\n";
					echo "<td  class=''><small>".$data['figure_series']."</small></td>\n";				
			echo "</tr>\n";	

			// Manufacturer
			echo "<tr>\n"; 			
					echo "<td  class='navbar-default'><div class='text-smaller text-uppercase'><strong>".$locale['figure_417'].":</strong></div></td>\n";
					echo "<td  class=''><small>".$data['figure_manufacturer_name']."</small></td>\n";
			echo "</tr>\n";
			
			// Release Date
			echo "<tr>\n";		
					echo "<td  class='navbar-default'><div class='text-smaller text-uppercase'><strong>".$locale['figure_419'].":</strong></div></td>\n";
					echo "<td  class=''><small>".$data['figure_year']."</small></td>\n";
			echo "</tr>\n";
			
			// Country
			echo "<tr>\n"; 			
					echo "<td  class='navbar-default'><div class='text-smaller text-uppercase'><strong>".$locale['figure_436'].":</strong></div></td>\n";
					echo "<td  class=''><small>".$data['figure_country']."</small></td>\n";						
			echo "</tr>\n";
			
			// Artists
			echo "<tr>\n"; 			
					echo "<td  class='navbar-default'><div class='text-smaller text-uppercase'><strong>".$locale['figure_452'].":</strong></div></td>\n";
					echo "<td  class=''><small>".$data['figure_artists']."</small></td>\n";						
						
			//BLANK LINE		
			echo "<tr>\n";
					echo "<td class='active'></td>\n";
					echo "<td class='active'></td>\n";	
			echo "</tr>\n";
			
			// Scale
			echo "<tr>\n"; 			
					echo "<td  class='navbar-default'><div class='text-smaller text-uppercase'><strong>".$locale['figure_442'].":</strong></div></td>\n";
					echo "<td  class=''><small>".$data['figure_scale_name']."</small></td>\n";	
			echo "</tr>\n";	
			
			// Weight
			echo "<tr>\n";			
					echo "<td  class='navbar-default'><div class='text-smaller text-uppercase'><strong>".$locale['figure_443'].":</strong></div></td>\n";
					echo "<td  class=''><small>".$data['figure_weight']."</small></td>\n";	
			echo "</tr>\n";			
						
			// Height
			echo "<tr>\n";			
					echo "<td  class='navbar-default'><div class='text-smaller text-uppercase'><strong>".$locale['figure_444'].":</strong></div></td>\n";
			
					$height = dbquery("SELECT fm.figure_measurements_id, fm.figure_measurements_inch, f.figure_height
						FROM ".DB_FIGURE_MEASUREMENTS." fm
						INNER JOIN ".DB_FIGURE_ITEMS." f ON f.figure_height = fm.figure_measurements_id
						WHERE figure_id='".$data['figure_id']."'");
				   
					if(dbrows($height)){
					   while($dataheight = dbarray($height)){	
			
					echo "<td  class=''><small>".$dataheight['figure_measurements_inch']."</small></td>\n";
						}
					}						
			echo "</tr>\n";	
			
				
			// Width
			echo "<tr>\n"; 	
					echo "<td  class='navbar-default'><div class='text-smaller text-uppercase'><strong>".$locale['figure_445'].":</strong></div></td>\n";
				
					$width = dbquery("SELECT fm.figure_measurements_id, fm.figure_measurements_inch, f.figure_width
						FROM ".DB_FIGURE_MEASUREMENTS." fm
						INNER JOIN ".DB_FIGURE_ITEMS." f ON f.figure_width = fm.figure_measurements_id
						WHERE figure_id='".$data['figure_id']."'");
				   
					if(dbrows($width)){
					   while($datawidth = dbarray($width)){	
			
				echo "<td  class=''><small>".$datawidth['figure_measurements_inch']."</small></td>\n";	
						}
					}				
			echo "</tr>\n";
					
					
			// Depth
			echo "<tr>\n"; 			
					echo "<td  class='navbar-default'><div class='text-smaller text-uppercase'><strong>".$locale['figure_446'].":</strong></div></td>\n";
						
						$depth = dbquery("SELECT fm.figure_measurements_id, fm.figure_measurements_inch, f.figure_depth
						   FROM ".DB_FIGURE_MEASUREMENTS." fm
						   INNER JOIN ".DB_FIGURE_ITEMS." f ON f.figure_depth = fm.figure_measurements_id
						   WHERE figure_id='".$data['figure_id']."'");
						   
						   if(dbrows($depth)){
							   while($datadepth = dbarray($depth)){	
								echo "<td  class=''><small>".$datadepth['figure_measurements_inch']."</small></td>\n";
								}
							}	
			echo "</tr>\n";
			
			//BLANK LINE		
			echo "<tr>\n";
					echo "<td class='active'></td>\n";
					echo "<td class='active'></td>\n";	
			echo "</tr>\n";
			
			// Brand
			echo "<tr>\n"; 				
					echo "<td  class='navbar-default'><div class='text-smaller text-uppercase'><strong>".$locale['figure_438'].":</strong></div></td>\n";
					echo "<td  class=''><small>".$data['figure_brand_name']."</small></td>\n";		
			echo "</tr>\n";					
					
										
			//  Material
			echo "<tr>\n"; 				
					echo "<td  class='navbar-default'><div class='text-smaller text-uppercase'><strong>".$locale['figure_447'].":</strong></div></td>\n";
					echo "<td  class=''><small>".$data['figure_material_name']."</small></td>\n";
			echo "</tr>\n";
					
			// Articulations Points
			echo "<tr>\n"; 			
					echo "<td  class='navbar-default'><div class='text-smaller text-uppercase'><strong>".$locale['figure_455'].":</strong></div></td>\n";
					echo "<td  class=''><small>".$data['figure_poa_name']."</small></td>\n";				
			echo "</tr>\n";	
									
			// Packaging
			echo "<tr>\n"; 		
					echo "<td  class='navbar-default'><div class='text-smaller text-uppercase'><strong>".$locale['figure_448'].":</strong></div></td>\n";
					echo "<td  class=''><small>".$data['figure_packaging_name']."</small></td>\n";	
			echo "</tr>\n";
									
			//BLANK LINE		
			echo "<tr>\n";
					echo "<td class='active'></td>\n";
					echo "<td class='active'></td>\n";	
			echo "</tr>\n";
			
			// MSRP (Price by Release)
			echo "<tr>\n"; 				
					echo "<td  class='navbar-default'><div class='text-smaller text-uppercase'><strong>".$locale['figure_449'].":</strong></div></td>\n";
					echo "<td  class=''><small>".$data['figure_retailprice']."</small></td>\n";					
			echo "</tr>\n";
			
			// Used Price	
			echo "<tr>\n"; 				
					echo "<td  class='navbar-default'><div class='text-smaller text-uppercase'><strong>".$locale['figure_456'].":</strong></div></td>\n";
					echo "<td  class=''><small>".$data['figure_usedprice']."</small></td>\n";
			echo "</tr>\n";			

			// Limited Edition YES/NO 
			echo "<tr>\n"; 
					echo "<td  class='navbar-default'><div class='text-smaller text-uppercase'><strong>".$locale['figure_450'].":</strong></div></td>\n";
					echo "<td  class=''><small>".$data['figure_limitation_name']."</small></td>\n";
			echo "</tr>\n";
			
			// Edition Size
			echo "<tr>\n"; 
					echo "<td  class='navbar-default'><div class='text-smaller text-uppercase'><strong>".$locale['figure_451'].":</strong></div></td>\n";
					echo "<td  class=''><small>".$data['figure_editionsize']."</small></td>\n";
			echo "</tr>\n";
						
			//BLANK LINE		
			echo "<tr>\n";
					echo "<td class='active'></td>\n";
					echo "<td class='active'></td>\n";	
			echo "</tr>\n";

			// Accessories 	
			echo "<tr>\n"; 			
					echo "<td  class='navbar-default'><div class='text-smaller text-uppercase'><strong>".$locale['figure_457'].":</strong></div></td>\n";					
					echo "<td style='word-break: break-all; word-wrap: break-word;'><small>".($data['figure_accessories'] ? $data['figure_accessories'] : "-")."</small></td>\n";						
					//echo "<td  class=''><small><div style='width:45em;'><span style='word-wrap: break-word; word-break: break-all;'>".($data['figure_accessories'] ? $data['figure_accessories'] : "-")."</span></div></small></td>\n";	
			echo "</tr>\n";
			
			// Discreption 
			echo "<tr>\n";				
					echo "<td  class='navbar-default'><div class='text-smaller text-uppercase'><strong>".$locale['figure_423'].":</strong></div></td>\n";
					echo "<td style='word-break: break-all; word-wrap: break-word;'><small>".nl2br(parseubb(parsesmileys($data['figure_description'])))."</small></td>";	
					//echo "<td  class='list-group-item'><small><div style='width:45em;'><span style='word-wrap: break-word; word-break: break-all;'>".nl2br(parseubb(parsesmileys($data['figure_description'])))."</span></div></small></td>";		
			echo "</tr></table>\n";	

closeside();
// ############################################################################################

// ###### LINK FOR ADMINS TO EDIT THE FIGURE ##################################################
if (iADMIN || iSUPERADMIN) {

	openside("<div class='well clearfix'><strong>ADMIN OPTIONS</strong></div>");

		global $aidlink;
		$settings = fusion_get_settings();
				// ['cifg_0005'] = "Edit";
				echo "<div align='center'>\n";
				echo "<a class='btn btn-sm btn-danger' href='".INFUSIONS."figurelib/admin.php".$aidlink."&amp;section=figurelib_form&amp;action=edit&amp;figure_id=".$_GET['figure_id']."'>".$locale['cifg_0005a']."</a><p>"; 
				echo "</div>";
	closeside();		
}
// ############################################################################################	


// ########  AFFILIATE PANEL  #################################################################
openside("<div class='well clearfix'><strong>AFFILIATES</strong></div>");						
				
	// CSS 
		echo "<style type='text/css'>
		<!--
		table {
		  border-collapse: collapse;
		  border: 1px solid #eeeeee;
		}
		-->
		</style>\n";	
					
			echo "<table style='cellspacing:10px; cellpadding:10px;' class='table' width='100%'>\n";
		
			 // FIRST LINE ESHOP (PRIORITY 1)		 
			 if ($data['figure_eshop'] == "") { 
						} else { 
						echo "<tr><td style='text-align:center; vertical-align:middle;' colspan='4'><a href='".$data['figure_eshop']."'</a>".trimlink($data['figure_eshop'],15)."</td></tr>\n"; }	
			 
			// SECOND LINE AFFILIATE (PRIORITY 2)			 
			 if ($data['figure_affiliate_1']  ||  $data['figure_affiliate_2'] ||  $data['figure_affiliate_3'] || $data['figure_affiliate_4'] != "") { 
			 
				 echo "<tr>\n";
				 echo "<colgroup><col width='25%'><col width='25%'><col width='25%'><col width='25%'></colgroup>\n"; 
				 echo "<td style='text-align:center; vertical-align:middle;'>	\n";	 
						if ($data['figure_affiliate_1'] == "") { echo "<strike>".$locale['figure_033']."</strike>";
							} else { echo "<a href='".$data['figure_affiliate_1']."'</a>".trimlink($data['figure_affiliate_1'],15)."</td>\n"; }		 
				 echo "<td align='center'>\n";	 
						if ($data['figure_affiliate_2'] == "") { echo "<strike>".$locale['figure_033']."</strike>";
							} else { echo "<a href='".$data['figure_affiliate_2']."'</a>".trimlink($data['figure_affiliate_2'],15)."</td>\n"; }	
				 echo "<td align='center'>\n";	 
						if ($data['figure_affiliate_3'] == "") { echo "<strike>".$locale['figure_033']."</strike>";
							} else { echo "<a href='".$data['figure_affiliate_3']."'</a>".trimlink($data['figure_affiliate_3'],15)."</td>\n"; }	
				 echo "<td align='center'>\n";	 
						if ($data['figure_affiliate_4'] == "") { echo "<strike>".$locale['figure_033']."</strike>";
							} else { echo "<a href='".$data['figure_affiliate_4']."'</a>".trimlink($data['figure_affiliate_4'],15)."</td>\n"; }	
				 echo "</tr>\n";
			 } else { 
			 }
			 
			// THIRD LINE AFFILIATE (PRIORITY 2)		 
			if ($data['figure_affiliate_5']  ||  $data['figure_affiliate_6'] ||  $data['figure_affiliate_7'] || $data['figure_affiliate_8'] != "") { 
			 
				 echo "<tr>\n";
				 echo "<colgroup><col width='25%'><col width='25%'><col width='25%'><col width='25%'></colgroup>\n"; 
				 echo "<td style='text-align:center; vertical-align:middle;'>	\n";	 
						if ($data['figure_affiliate_5'] == "") { echo "<strike>".$locale['figure_033']."</strike>";
							} else { echo "<a href='".$data['figure_affiliate_5']."'</a>".trimlink($data['figure_affiliate_5'],15)."</td>\n"; }		 
				 echo "<td align='center'>\n";	 
						if ($data['figure_affiliate_6'] == "") { echo "<strike>".$locale['figure_033']."</strike>";
							} else { echo "<a href='".$data['figure_affiliate_6']."'</a>".trimlink($data['figure_affiliate_6'],15)."</td>\n"; }	
				 echo "<td align='center'>\n";	 
						if ($data['figure_affiliate_7'] == "") { echo "<strike>".$locale['figure_033']."</strike>";
							} else { echo "<a href='".$data['figure_affiliate_7']."'</a>".trimlink($data['figure_affiliate_7'],15)."</td>\n"; }	
				 echo "<td align='center'>\n";	 
						if ($data['figure_affiliate_8'] == "") { echo "<strike>".$locale['figure_033']."</strike>";
							} else { echo "<a href='".$data['figure_affiliate_8']."'</a>".trimlink($data['figure_affiliate_8'],15)."</td>\n"; }	
				 echo "</tr>\n";
			
			} else { 
			 }
			
			// FOURTH LINE AMAZON COM CA UK DE	

				echo "<tr>\n";
				echo "<colgroup><col width='25%'><col width='25%'><col width='25%'><col width='25%'></colgroup>\n"; 
						
				echo "<td style='text-align:center; vertical-align:middle;'>	\n";	 
					if ($data['figure_amazon_com'] == "") { echo "<img src='".INFUSIONS."figurelib/images/flags/flag_usa_sw.png"."' alt='".$locale['figure_031a']."' title='".$locale['figure_031a']."'>";
						} else { echo "<a href='".$data['figure_amazon_com']."'><img src='".INFUSIONS."figurelib/images/flags/flag_usa.png"."' alt='".trimlink($data['figure_amazon_com'],50)."' title='".trimlink($data['figure_amazon_com'],100)."'></td>\n"; }		 
			
				echo "<td align='center'>\n";	 
					if ($data['figure_amazon_ca'] == "") { echo "<img src='".INFUSIONS."figurelib/images/flags/flag_canada_sw.png"."' alt='".$locale['figure_032a']."' title='".$locale['figure_032a']."'>";
						} else { echo "<a href='".$data['figure_amazon_ca']."'><img src='".INFUSIONS."figurelib/images/flags/flag_canada.png"."' alt='".trimlink($data['figure_amazon_ca'],50)."' title='".trimlink($data['figure_amazon_ca'],100)."'></td>\n"; }	
			 			 	 
				echo "<td align='center'>\n";	 
			 		if ($data['figure_amazon_uk'] == "") { echo "<img src='".INFUSIONS."figurelib/images/flags/flag_great_britain_sw.png"."' alt='".$locale['figure_026a']."' title='".$locale['figure_026a']."'>";
						} else { echo "<a href='".$data['figure_amazon_ca']."'><img src='".INFUSIONS."figurelib/images/flags/flag_great_britain.png"."' alt='".trimlink($data['figure_amazon_ca'],50)."' title='".trimlink($data['figure_amazon_ca'],100)."'></td>\n"; }	
				
				echo "<td align='center'>\n";	 
			 		if ($data['figure_amazon_de'] == "") { echo "<img src='".INFUSIONS."figurelib/images/flags/flag_germany_sw.png"."' alt='".$locale['figure_025a']."' title='".$locale['figure_025a']."'>";
						} else { echo "<a href='".$data['figure_amazon_de']."'><img src='".INFUSIONS."figurelib/images/flags/flag_germany.png"."' alt='".trimlink($data['figure_amazon_de'],50)."' title='".trimlink($data['figure_amazon_de'],100)."'></td>\n"; }	
				echo "</tr>\n";
			 		 
			 // FIFTH LINE AMAZON JP FR ES IT
				echo "<tr>\n";
				echo "<colgroup><col width='25%'><col width='25%'><col width='25%'><col width='25%'></colgroup>\n"; 
			

				echo "<td style='text-align:center; vertical-align:middle;'>	\n";
					if ($data['figure_amazon_jp'] == "") { echo "<img src='".INFUSIONS."figurelib/images/flags/flag_japan_sw.png"."' alt='".$locale['figure_030a']."' title='".$locale['figure_030a']."'>";
						} else { echo "<a href='".$data['figure_amazon_jp']."'><img src='".INFUSIONS."figurelib/images/flags/flag_japan.png"."' alt='".trimlink($data['figure_amazon_jp'],50)."' title='".trimlink($data['figure_amazon_jp'],100)."'></td>\n"; }		
			
				echo "<td align='center'>\n";
					if ($data['figure_amazon_fr'] == "") { echo "<img src='".INFUSIONS."figurelib/images/flags/flag_france_sw.png"."' alt='".$locale['figure_027a']."' title='".$locale['figure_027a']."'>";
						} else { echo "<a href='".$data['figure_amazon_fr']."'><img src='".INFUSIONS."figurelib/images/flags/flag_france.png"."' alt='".trimlink($data['figure_amazon_fr'],50)."' title='".trimlink($data['figure_amazon_fr'],100)."'></td>\n"; }	
			 		 
				echo "<td align='center'>\n";
			 		if ($data['figure_amazon_es'] == "") { echo "<img src='".INFUSIONS."figurelib/images/flags/flag_spain_sw.png"."' alt='".$locale['figure_028a']."' title='".$locale['figure_028a']."'>";
						} else { echo "<a href='".$data['figure_amazon_es']."'><img src='".INFUSIONS."figurelib/images/flags/flag_spain.png"."' alt='".trimlink($data['figure_amazon_es'],50)."' title='".trimlink($data['figure_amazon_es'],100)."'></td>\n"; }	
				
				echo "<td align='center'>\n";
			 		if ($data['figure_amazon_it'] == "") { echo "<img src='".INFUSIONS."figurelib/images/flags/flag_italy_sw.png"."' alt='".$locale['figure_029a']."' title='".$locale['figure_029a']."'>";
						} else { echo "<a href='".$data['figure_amazon_it']."'><img src='".INFUSIONS."figurelib/images/flags/flag_italy.png"."' alt='".trimlink($data['figure_amazon_it'],50)."' title='".trimlink($data['figure_amazon_it'],100)."'></td>\n"; }	
				echo "</tr></table>\n";			
closeside();
// ############################################################################################

				
// ####### USERFIGURES  #######################################################################
		// LOCALE
		$locale['userfigure_001'] ="Add to collection";
		$locale['userfigure_002'] ="Delete from collection";
		$locale['userfigure_003'] ="The following members have this Figure: ";
		$locale['userfigure_004'] ="No members have this Figure - be the first :)";
		$locale['userfigure_005'] ="FIGURE STATS";
		$locale['userfigure_006'] ="Your Collection";			
	
	openside("<div class='well clearfix'><strong>".$locale['userfigure_005']."</strong></div>");	
	
	if (iMEMBER) {
		global $userdata;
							
			$resultuf = dbquery(
				"SELECT             
					fu.user_id, 
					fu.user_name, 
					fu.user_status, 
					fu.user_avatar, 
					fuf.figure_userfigures_figure_id,
					fuf.figure_userfigures_user_id          
            FROM ".DB_FIGURE_USERFIGURES." fuf
            INNER JOIN ".DB_USERS." fu ON fuf.figure_userfigures_user_id=fu.user_id  
            WHERE fuf.figure_userfigures_figure_id='".$data['figure_id']."'
            AND fu.user_id='".$userdata['user_id']."' 
			GROUP BY fu.user_id 
            ");
								
				$rows = dbrows($resultuf);

			// USER HAVE THE FIGURE
			if ($rows > 0) { 
						
					while ($datauf = dbarray($resultuf)) {
													
						if (isset($_POST['delete_from_collection'])) {
									
									dbquery("
										DELETE FROM ".DB_FIGURE_USERFIGURES." 
										WHERE figure_userfigures_figure_id=".$data['figure_id']." 
										AND figure_userfigures_user_id=".$userdata['user_id']." 
										");									
									redirect(clean_request("", array("delete_from_collection"), FALSE));

						}
					}
							echo openform('inputform', 'post', FUSION_REQUEST, array("class" => "",));
								echo "<div align='center'>\n";
								echo form_button("delete_from_collection", $locale['userfigure_002'], $locale['userfigure_002'], array("class" => "btn btn-sm btn-danger"));
								echo "  <a href='".INFUSIONS."figurelib/mycollection.php' class='btn btn-sm btn-primary'>".$locale['userfigure_006']."</a>";								
								//echo "  <a href='http://google.com' class='btn btn-sm btn-primary'>".$locale['sale']."</a>";
								echo "<p>";
								echo "</div>\n";
							echo closeform();
							

			// USER DOSEN'T HAVE THE FIGURE					
			} else { 
									
						if (isset($_POST['add_to_collection'])) {
											
							// Standard Values for Fields
							$inputArray = array(
							"figure_userfigures_figure_id" => $data['figure_id'], 
							"figure_userfigures_figure_id" => $userdata['user_id'], 
							);

							// SAVE DATA
							if (defender::safe()) {
									$inputArray = array(
										"figure_userfigures_figure_id" => $data['figure_id'],
										"figure_userfigures_user_id" => $userdata['user_id'],);
									dbquery_insert(DB_FIGURE_USERFIGURES, $inputArray, "save", array());	
									redirect(clean_request("", array("add_to_collection"), FALSE));									
							}
						}
					
							echo openform('inputform', 'post', FUSION_REQUEST, array("class" => "",));
								echo "<div align='center'>\n";
								echo form_button("add_to_collection", $locale['userfigure_001'], $locale['userfigure_001'], array("class" => "btn btn-sm btn-success"));
								echo "  <a href='".INFUSIONS."figurelib/mycollection.php' class='btn btn-sm btn-primary'>".$locale['userfigure_006']."</a>";								
								//echo "  <a href='http://google.com' class='btn btn-sm btn-primary'>".$locale['sale']."</a>";
								echo "</div>\n";
								echo "<p>";
							echo closeform();	
														
					}	
					
	}
	
// ########### 	LIST OF ALL USER WHERE HAVE THIS FIGURE  ##################################				

        $resultufc = dbquery(
				"SELECT             
					fu.user_id, 
					fu.user_name, 
					fu.user_status, 
					fu.user_avatar, 
					fuf.figure_userfigures_figure_id,
					fuf.figure_userfigures_user_id          
            FROM ".DB_FIGURE_USERFIGURES." fuf
            INNER JOIN ".DB_USERS." fu ON fuf.figure_userfigures_user_id=fu.user_id  
            WHERE fuf.figure_userfigures_figure_id='".$data['figure_id']."'
            AND fu.user_id='".$userdata['user_id']."' 
			GROUP BY fu.user_id 			
            ");	
	
		if (dbrows($resultufc) != 0) {
				echo "<div align='center'>\n";
				echo $locale['userfigure_003'];		
				echo "<p>";	
				
				
			while ($data = dbarray($resultufc)) {
				
				echo "<tr>\n<td class='side-small' align='left'>".THEME_BULLET."\n";
				echo "<a href='".BASEDIR."profile.php?lookup=".$data['user_id']."' title='".$data['user_name']."' class='side'>\n";
				echo trimlink($data['user_name'], 15)."</a></td>\n</tr>\n";
				echo "</div>";	
			}

		} else {
				echo "<div align='center'>\n";
				echo $locale['userfigure_004'];	
				echo "<p>";
				echo "</div>";				
		}	
closeside();
// ############################################################################################


// ###########  RELATED FIGURES  ##############################################################			
	$fil_settings = get_settings("figurelib");
	if ($fil_settings['figure_related']) { // RELATED FIGURES
		openside("<div class='well clearfix'><strong>RELATED FIGURES</strong></div>");	
					
				//echo "<div class='panel panel-default'>\n";

					$result3 = dbquery("
						SELECT 
							f.figure_id, 
							f.figure_title, 
							f.figure_datestamp, 
							f.figure_visibility, 
							fc.figure_cat_id, 
							fc.figure_cat_name,
							fm.figure_manufacturer_id,
							fm.figure_manufacturer_name							
						FROM ".DB_FIGURE_ITEMS." f 
						INNER JOIN ".DB_FIGURE_CATS." fc ON f.figure_cat=fc.figure_cat_id
						INNER JOIN ".DB_FIGURE_MANUFACTURERS." fm ON f.figure_manufacturer=fm.figure_manufacturer_id 						
						WHERE MATCH (figure_title) AGAINST ('".$data['figure_title']."' IN BOOLEAN MODE) 
						AND figure_id != ".$data['figure_id']." ".(iSUPERADMIN ? "" : "AND ".groupaccess('figure_visibility'))." 
						ORDER BY RAND() LIMIT 5");
				
					
					if (dbrows($result3)) {
						$i = 0;
												
							echo "<table width='100%' cellspacing='1' cellpadding='0' class=''>\n";	
							echo "<tbody><tr>\n";
							echo "<th class='' align='' width='30%'>".$locale['figure_411']."</th>\n";
							echo "<th class='' align='' width='30%'>".$locale['figure_417']."</th>\n";
							echo "<th class='' align='' width='30%'>".$locale['figure_413']."</th>\n";
							echo "<th class='' align='' width='10%'>".$locale['figure_418']."</th>\n";
							echo "</tr>\n";
						
						while ($data3 = dbarray($result3)) {

							$drating = dbarray(dbquery("SELECT SUM(rating_vote) sum_rating, COUNT(rating_item_id) count_votes FROM ".DB_RATINGS." WHERE rating_item_id='".$data3['figure_id']."' AND rating_type='FI'"));
							$num_votes = $drating['count_votes'];
							$rating = ($num_votes > 0 ? str_repeat("<img src='".INFUSIONS."figurelib/images/starsmall.png'>",ceil($drating['sum_rating']/$num_votes)) : "-");
							$cell_color = ($i % 2 == 0 ? "tbl1" : "tbl2"); $i++;
							echo "<tr>\n";
							echo "<td class='$cell_color' width='50%'><a href='figure.php?figure_id=".$data3['figure_id']."' title='".$data3['figure_title']."'>".$data3['figure_title']."</a></td>\n";
							echo "<td class='$cell_color' width='25%' align=''>".trimlink($data3['figure_manufacturer_name'],30)."</td>\n";
							echo "<td class='$cell_color' width='25%' align=''>".$data3['figure_cat_name']."</td>\n";
							echo "<td class='$cell_color' width='25%' align=''>".$rating."</td>\n";
							echo "</tr>\n";
						} 
					
					} else {
							
							echo "<tr><td class='tbl1' colspan='4' width='33%' align=''>".$locale['figure_426']."</td><br><br></tr>"; // ['figure_426'] = "No related figures found.";

					}
							//echo "</div>\n";
							echo "</tbody></table>\n";
		closeside();										
	}					
// ############################################################################################


// ######  RATING UND COMMENTS	###############################################################
	
	$fil_settings = get_settings("figurelib");
	if ($fil_settings['figure_allow_comments']) { // Comments
		openside("<div class='well clearfix'><strong>COMMENTS</strong></div>");	
		showcomments("FI", DB_FIGURE_ITEMS, "figure_id", $_GET['figure_id'], INFUSIONS."figurelib/figures.php?figure_id=".$_GET['figure_id']);
		closeside();
	}
		
	if ($fil_settings['figure_allow_ratings']) { // Ratings
		openside("<div class='well clearfix'><strong>RATINGS</strong></div>");
		showratings("FI", $_GET['figure_id'], INFUSIONS."figurelib/figures.php?figure_id=".$_GET['figure_id']);
		closeside();
	}
	
// ####### SOCIAL_SHARING   ###################################################################	
															
						// SETTINGS HOLEN
						//$settings = fusion_get_settings();
						$settings = fusion_get_settings();
						$fil_settings = get_settings("figurelib"); 

						if ($fil_settings['figure_social_sharing']) {
						openside("<div class='well clearfix'><strong>SOCIAL SHARING</strong></div>");	
							echo "<div style='text-align:center'>\n";
							$link = $settings['siteurl'].str_replace("../","",INFUSIONS)."figurelib/figure.php?figure_id=".$_GET['figure_id'];
							echo "<a href='http://www.facebook.com/share.php?u=".$link."' target='_blank'><img alt='Facebook' src='".INFUSIONS."figurelib/images/facebook.png' border='0'></a>&nbsp;\n";
							echo "<a href='http://twitter.com/share?url=".$link."' target='_blank'><img alt='Twitter' src='".INFUSIONS."figurelib/images/twitter.png' border='0'></a>&nbsp;\n";
							echo "<a href='http://digg.com/submit?url=".$link."' target='_blank'><img alt='Digg' src='".INFUSIONS."figurelib/images/digg.png' border='0'></a>&nbsp;\n";
							echo "<a href='http://reddit.com/submit?url=".$link."' target='_blank'><img alt='Reddit' src='".INFUSIONS."figurelib/images/reddit.png' border='0'></a>&nbsp;\n";
							echo "<a href='http://del.icio.us/post?url=".$link."' target='_blank'><img alt='Del.icio.us' src='".INFUSIONS."figurelib/images/delicious.png' border='0'></a>&nbsp;\n";
							echo "</div>\n";
						closeside();
						}	

// ############################################################################################		

	} // TO LINE 75
}	// TO LINE 74

// ############################################################################################
	
	
// ##### PRINT BUTTON #########################################################################
//echo "<a title='".$locale['news_0002']."' href='".$info['print_link']."'><i class='entypo print'></i></a>";
//echo "<a class='m-r-10' title='".$locale['news_0002']."' href='".$info['print_link']."'><i class='entypo print'></i></a>";
//echo "<a class='m-r-10' title='".$locale['news_0002']."' href='".BASEDIR."print.php?type=F&amp;item_id=".$data['figure_id']."'><i class='entypo print'></i></a>";
// ############################################################################################

echo "</aside>\n";

	} // TO LINE 31
	
} // TO LINE 32
	

function get_figure_image_path($figure_images_image, $figure_images_thumb, $hiRes = FALSE) {
    if (!$hiRes) {
        if ($figure_images_thumb && file_exists(THUMBS_FIGURES.$figure_images_thumb)) {
            return THUMBS_FIGURES.$figure_images_thumb;
        }
        if ($figure_images_thumb && file_exists(IMAGES_FIGURES.$figure_images_thumb)) {
            return IMAGES_FIGURES.$figure_images_thumb;
        }
        if ($figure_images_image && file_exists(IMAGES_FIGURES.$figure_images_image)) {
            return IMAGES_FIGURES.$figure_images_image;
        }
    } else {
        if ($figure_images_image && file_exists(IMAGES_FIGURES.$figure_images_image)) {
            return IMAGES_FIGURES.$figure_images_image;
        }
        if ($figure_images_thumb && file_exists(IMAGES_FIGURES.$figure_images_thumb)) {
            return IMAGES_FIGURES.$figure_images_thumb;
        }
        if ($figure_images_thumb && file_exists(THUMBS_FIGURES.$figure_images_thumb)) {
            return THUMBS_FIGURES.$figure_images_thumb;
        }
    }

}
